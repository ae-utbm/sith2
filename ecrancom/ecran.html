<!DOCTYPE html>
<html>
<!--
  Created using jsbin.com
  Source can be edited via http://jsbin.com/AsAcATA/5/edit
-->
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8"> 
  <script id="ambilight-script"
                data-mask="./img/mask.png"
                data-selector="#slideDiv img"
                src="http://azproduction.ru/image-ambilight/ambilight-image.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script>
    <title></title>

<style id="jsbin-css">
#slideDiv>*{

}
#slideDiv {
    z-index: 1;
    min-height:100%;
    height: 1200px;
    background:rgb(0,0,50);
    background: radial-gradient( rgb(67, 66, 72), #05050F);
    vertical-align:middle;
    margin-top:auto;
    margin-bottom:auto;
    margin-left: auto;
    margin-right:auto;
    text-align:center;
}
.logmessage{
}
b{
  color:darkred;
  position : absolute;
  left:0;
  margin-left:5px;
}
.notif>*>p{
  text-align:right;
  margin-right:5px;
}
.notif{
    position: absolute;
    text-align: center;
    font-size: 50px;
    font-family:verdana;
    width: 100%;
    bottom: 0;
    margin: 0 auto;
    z-index: 2;
      background:rgba(255,255,255,0.7);
      border-top:-5px solid #FF8800;

  color:black;
}
body{
      background: radial-gradient( rgb(67, 66, 72), #05050F);
    margin: 0 0 0 0 ;
    display:flex;
  flex-direction:column;
    flex:fill;
    justify-content:center;
  align-content:stretch;
}
figure{
    max-width: 100%;
    display: flex;
    flex-direction:row;
    margin:0 0 0 0 ;

}
.flexImg{
    max-width: 100%;
     background: radial-gradient( rgb(67, 66, 72), #05050F);

    height:1200px;
    vertical-align:middle;
    margin-top:auto;
    margin-bottom:auto;
    margin-left: auto;
    margin-right: auto;
    }
</style>
</head>
<body>
   <div id="slideDiv" class="flexbox">
   </div>
   <div class="notif"></div>
<script>
version="RC 1.0";
incomingMessage=[];
affiches=[];
pathToimg="http://ae.utbm.fr/data/files/";
timeRefresh=6000 // in miliss
msgRefresh=3000
logDiv=$("#logDiv");



refreshAffiche=function(){
    var xmlFile=$.get("http://ae.utbm.fr/affiches.php?page=xml");
    slideDiv.empty();
    xmlFile.error(function(self,errorCode,error){
        //log.error("something went wrong");
        //msg.content="unable to connect to ae.utbm.fr err: "+errorCode;
        //msg.level="error";
        //logDiv.appendChild(msg.toHTML());
        setTimeout(function(){
            logDiv.fadeIn("fast");
        },10000);
        //logDiv.removeChild(msg.toHTML());
        return;
    });
    xmlFile.success(function(r){
    try{
        var xml=$(r);
        var presentation=$(xml.find("presentation"));
        for(var i=0;i<presentation.children().length;i++){
            affiche=$(presentation.find("affiche")[i]);
            path=pathToimg+$(affiche.find("fichier")).text();
            newAffiche={
              html:"<figure><img class='flexImg' src='"+path+"' alt='image missing'/></figure>",
                next:""
            };
            if(i!==0){
                affiches[i-1].next=newAffiche;
            }
            affiches.push(newAffiche);
        }
        if(presentation.children().length>1){
          affiches[affiches.length-1].next=affiches[0];
        }
        if(presentation.children().length==1){
            affiche[0].next=affiches[0]
        }
    }
    catch(Exception){
        alert(Exception.message);
    }
    console.log(affiches.length);
    launchslideShow()
    launchMessageService()
    });
};

launchMessageService=function(){
  setTimeout(function(){
      messageCheck();
      launchMessageService();
  },msgRefresh);
}
launchslideShow=function(){
    if(affiches.length>0){
        show(affiches[0]);
    }
    else{
        logger("Init in progress version="+version,"success")
    }
}
messageCheck=function(){
  if($(".logmessage").length>0){
    $($(".logmessage")[0]).fadeOut(msgRefresh);
    setTimeout(function(){
      $($(".logmessage")[0]).remove();
     if($(".logmessage").length==0){
       $(".notif").fadeOut("slow"); 
       
    }},msgRefresh);
  }else{
      $(".notif").fadeOut("slow");
  }
  $.ajax({
    url:"http://ae.utbm.fr/gateway.php?module=ecrancom&secret=messageForTheLulz",
    error:function(self,errorcode,error){
      logger("unable to retrieve message "+errorcode,"error");
    },
    success:function(response){
      if(!response){
        return;
      }
      
      message=response.split('\n').slice(2,response.split('\n').length).join();
      
      logger("<b>"+response.split('\n')[0]+":</b><p>"+message+"</p>","");
    }
  });
}
show=function(affiche){
    //if comment were print, you will see me a lot!
    current=affiche;
    setTimeout(function(){
        $("#slideDiv").html(current.html);
        setTimeout(function(){
            show(current.next);
        },20);
    },timeRefresh)
}
logger = function (message, type) {
  if($(".logmessage").length==0){
    $(".notif").fadeIn(600); 
  }
  toAppend="<pre class='logmessage' style='display:none;'>"+message+"</pre>";
    $(".notif").append(toAppend);
  $(".logmessage").fadeIn(400);
  
};
$(document).ready(function(){
    slideDiv=$("#slider");
    refreshAffiche();
    launchslideShow();
});
</script>
</body>
</html>
